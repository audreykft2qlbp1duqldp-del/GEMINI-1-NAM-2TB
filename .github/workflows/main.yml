name: YouTube Audio → Drive (fixed)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"   # giữ hay bỏ tuỳ repo bạn (KHÔNG bắt buộc)

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read

    env:
      # ==== TUỲ CHỈNH NHANH ====
      SLEEP_SECONDS: "8"
      MAX_PER_RUN: "40"

      # ==== GOOGLE DRIVE ====
      # Chỉ cần 1 trong 2:
      # 1) GDRIVE_OAUTH_TOKEN_JSON: OAuth User (dùng tài khoản cá nhân)
      # 2) GDRIVE_SA_JSON: Service Account (nếu dùng Shared Drive hay tài khoản bot)
      GDRIVE_OAUTH_TOKEN_JSON: ${{ secrets.GDRIVE_OAUTH_TOKEN_JSON }}
      GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

      # ==== YouTube extractor (tuỳ chọn) ====
      PO_TOKEN: ${{ secrets.PO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system deps (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # >>> NEW: Cập nhật yt-dlp nightly để tránh nsig + SABR trên YouTube
      - name: Update yt-dlp to nightly
        run: |
          python -m pip install --upgrade --pre yt-dlp-nightly
          yt-dlp --version

      - name: Install Python deps
        run: |
          python -m pip install --upgrade google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      # (TÙY CHỌN) Nếu cookies ở secret, ghi ra file multi-set
      - name: Write cookies_multi.txt (optional)
        if: ${{ secrets.YT_COOKIES_MULTI != '' }}
        run: |
          mkdir -p data
          printf "%s" "${{ secrets.YT_COOKIES_MULTI }}" > data/cookies_multi.txt

      # (TÙY CHỌN) Nếu po_token lưu file thay vì env
      - name: Write po_token.txt (optional)
        if: ${{ secrets.PO_TOKEN_FILE != '' }}
        run: |
          mkdir -p data
          printf "%s" "${{ secrets.PO_TOKEN_FILE }}" > data/po_token.txt

      # Chạy tool: giữ nguyên tên/thư mục như repo của bạn
      - name: Run: YouTube audio -> Drive
        run: |
          python -u yt_audio_to_drive.py
